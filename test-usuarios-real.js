#!/usr/bin/env node

/**
 * üß™ SCRIPT DE PRUEBAS REALES PARA TABLA USUARIOS EN FIRESTORE
 * 
 * Este script realiza pruebas REALES de CRUD en la nueva tabla 'usuarios'
 * usando las mismas configuraciones que la aplicaci√≥n Angular.
 */

const { initializeApp } = require('firebase/app');
const { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, limit } = require('firebase/firestore');

// Configuraci√≥n de Firebase (la misma que usa la aplicaci√≥n)
const firebaseConfig = {
  apiKey: "AIzaSyC54Ytk5wO2zupIuCtFIsIUNXvP4m9qqOk",
  authDomain: "bocket-2024.firebaseapp.com",
  projectId: "bocket-2024",
  storageBucket: "bocket-2024.appspot.com",
  messagingSenderId: "537532907057",
  appId: "1:537532907057:web:dc51aacd0553b9ac2edf10"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Configuraci√≥n de pruebas
const RESTAURANTE_PRUEBA = 'test-restaurant-' + Date.now();
const USUARIOS_COLLECTION = `clients/${RESTAURANTE_PRUEBA}/usuarios`;
const FORMULARIOS_USUARIOS_COLLECTION = `clients/${RESTAURANTE_PRUEBA}/formularios/usuarios/datos`;

// Datos de prueba REALES
const usuariosPrueba = [
  {
    id: 'user-test-001',
    name: 'Ana Garc√≠a Test',
    whatsAppName: 'Ana Garc√≠a Test',
    email: 'ana.garcia.test@example.com',
    isWAContact: true,
    isMyContact: true,
    isEnterprise: false,
    isBusiness: false,
    sourceType: 'manual',
    respType: 'manual',
    labels: 'usuario_vip,premium,test',
    creation: new Date().toISOString(),
    lastUpdate: new Date().toISOString(),
    userInteractions: {
      whatsapp: 3,
      controller: 2,
      chatbot: 1,
      api: 0,
      campaing: 1,
      client: 5,
      others: 0,
      wappController: 2,
      ai: 1,
      fee: 2500
    }
  },
  {
    id: 'user-test-002',
    name: 'Carlos L√≥pez Test',
    whatsAppName: 'Carlos L√≥pez Test',
    email: 'carlos.lopez.test@example.com',
    isWAContact: true,
    isMyContact: true,
    isEnterprise: true,
    isBusiness: true,
    sourceType: 'chatBot',
    respType: 'bot',
    labels: 'usuario_corporativo,empresa,test',
    creation: new Date().toISOString(),
    lastUpdate: new Date().toISOString(),
    userInteractions: {
      whatsapp: 5,
      controller: 3,
      chatbot: 2,
      api: 1,
      campaing: 2,
      client: 8,
      others: 1,
      wappController: 3,
      ai: 2,
      fee: 15000
    }
  },
  {
    id: 'user-test-003',
    name: 'Mar√≠a Rodr√≠guez Test',
    whatsAppName: 'Mar√≠a R Test',
    email: 'maria.rodriguez.test@example.com',
    isWAContact: true,
    isMyContact: true,
    isEnterprise: false,
    isBusiness: false,
    sourceType: 'manual',
    respType: 'manual',
    labels: 'usuario_regular,test',
    creation: new Date().toISOString(),
    lastUpdate: new Date().toISOString(),
    userInteractions: {
      whatsapp: 1,
      controller: 1,
      chatbot: 0,
      api: 0,
      campaing: 0,
      client: 2,
      others: 0,
      wappController: 1,
      ai: 0,
      fee: 0
    }
  }
];

function logSeparator() {
  console.log('\n' + '='.repeat(80));
}

function logSubsection(title) {
  console.log(`\n${'‚îÄ'.repeat(40)}`);
  console.log(`üìã ${title}`);
  console.log(`${'‚îÄ'.repeat(40)}`);
}

async function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// PRUEBA 1: CREAR USUARIOS REALES
async function pruebaCrearUsuarios() {
  logSubsection('PRUEBA 1: CREAR USUARIOS EN FIRESTORE REAL');
  
  try {
    console.log(`üìç Creando usuarios en: ${USUARIOS_COLLECTION}`);
    
    for (const usuario of usuariosPrueba) {
      console.log(`\nüîÑ Creando usuario REAL: ${usuario.name} (${usuario.id})`);
      
      // Crear en tabla principal de usuarios usando Firebase v9
      const usuarioRef = doc(db, USUARIOS_COLLECTION, usuario.id);
      await setDoc(usuarioRef, usuario);
      console.log(`‚úÖ Usuario creado REALMENTE en Firestore: ${usuario.id}`);
      
      // Crear tambi√©n en formularios organizados
      const timestamp = Date.now();
      const formularioData = {
        id: `${timestamp}_usuario_${usuario.id}`,
        tipoFormulario: 'usuarios',
        restauranteSlug: RESTAURANTE_PRUEBA,
        chatId: usuario.id,
        timestamp: timestamp,
        nombre: usuario.name,
        email: usuario.email,
        telefono: usuario.whatsAppName,
        tipoUsuario: usuario.labels?.includes('vip') ? 'VIP' : 
                    usuario.labels?.includes('corporativo') ? 'Corporativo' : 'Regular',
        labels: usuario.labels,
        activo: true,
        fechaCreacion: new Date().toISOString(),
        source: 'test_script_real'
      };
      
      const formularioRef = doc(db, FORMULARIOS_USUARIOS_COLLECTION, formularioData.id);
      await setDoc(formularioRef, formularioData);
      console.log(`‚úÖ Formulario de usuario creado REALMENTE: ${formularioData.id}`);
      
      await delay(200); // Pausa entre creaciones
    }
    
    console.log(`\nüéâ ¬°${usuariosPrueba.length} usuarios creados REALMENTE en Firestore!`);
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL creando usuarios:', error);
    return false;
  }
}

// PRUEBA 2: CONSULTAR USUARIOS REALES
async function pruebaConsultarUsuarios() {
  logSubsection('PRUEBA 2: CONSULTAR USUARIOS REALES DE FIRESTORE');
  
  try {
    console.log(`üìç Consultando usuarios REALES desde: ${USUARIOS_COLLECTION}`);
    
    const usuariosCollection = collection(db, USUARIOS_COLLECTION);
    const snapshot = await getDocs(usuariosCollection);
    
    console.log(`üìä Total de usuarios REALES encontrados: ${snapshot.size}`);
    
    if (snapshot.empty) {
      console.log('‚ö†Ô∏è No se encontraron usuarios REALES');
      return false;
    }
    
    console.log('\nüìã Lista de usuarios REALES:');
    snapshot.forEach((docSnap, index) => {
      const data = docSnap.data();
      console.log(`${index + 1}. ${data.name} (${docSnap.id})`);
      console.log(`   üìß Email: ${data.email || 'No especificado'}`);
      console.log(`   üè∑Ô∏è Labels: ${data.labels || 'Sin labels'}`);
      console.log(`   üì± WhatsApp: ${data.whatsAppName || 'No especificado'}`);
      console.log(`   üí∞ Fee: $${data.userInteractions?.fee || 0}`);
      console.log(`   üìÖ Creado: ${data.creation}`);
    });
    
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL consultando usuarios:', error);
    return false;
  }
}

// PRUEBA 3: ACTUALIZAR USUARIO REAL
async function pruebaActualizarUsuario() {
  logSubsection('PRUEBA 3: ACTUALIZAR USUARIO REAL');
  
  try {
    const usuarioId = usuariosPrueba[0].id;
    console.log(`üìç Actualizando usuario REAL: ${usuarioId}`);
    
    const datosActualizacion = {
      email: 'ana.garcia.updated.REAL@example.com',
      labels: 'usuario_vip_actualizado,premium,updated,REAL',
      lastUpdate: new Date().toISOString(),
      'userInteractions.fee': 5000
    };
    
    const usuarioRef = doc(db, USUARIOS_COLLECTION, usuarioId);
    await updateDoc(usuarioRef, datosActualizacion);
    console.log('‚úÖ Usuario actualizado REALMENTE en Firestore');
    
    // Verificar la actualizaci√≥n REAL
    const docActualizado = await getDoc(usuarioRef);
    
    if (docActualizado.exists()) {
      const data = docActualizado.data();
      console.log('üìã Datos actualizados REALES:');
      console.log(`   üìß Nuevo email: ${data.email}`);
      console.log(`   üè∑Ô∏è Nuevas labels: ${data.labels}`);
      console.log(`   üí∞ Nuevo fee: $${data.userInteractions?.fee}`);
      console.log(`   üïê √öltima actualizaci√≥n: ${data.lastUpdate}`);
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL actualizando usuario:', error);
    return false;
  }
}

// PRUEBA 4: CONSULTAS CON FILTROS REALES
async function pruebaConsultarPorFiltros() {
  logSubsection('PRUEBA 4: CONSULTAS REALES CON FILTROS');
  
  try {
    // Consulta 1: Usuarios que contengan "test" en labels
    console.log('\nüîç Consultando usuarios de prueba (labels contiene "test")...');
    const usuariosCollection = collection(db, USUARIOS_COLLECTION);
    
    // Como Firestore no tiene array-contains-any directo con strings, consultamos todos y filtramos
    const allSnapshot = await getDocs(usuariosCollection);
    let testUsers = [];
    
    allSnapshot.forEach(doc => {
      const data = doc.data();
      if (data.labels && data.labels.includes('test')) {
        testUsers.push(data);
      }
    });
    
    console.log(`üìä Usuarios de prueba encontrados: ${testUsers.length}`);
    testUsers.forEach(user => {
      console.log(`   - ${user.name} (labels: ${user.labels})`);
    });
    
    // Consulta 2: Usuarios corporativos REALES
    console.log('\nüîç Consultando usuarios corporativos REALES...');
    const corpQuery = query(usuariosCollection, where('isEnterprise', '==', true));
    const corpSnapshot = await getDocs(corpQuery);
    
    console.log(`üìä Usuarios corporativos REALES encontrados: ${corpSnapshot.size}`);
    corpSnapshot.forEach(doc => {
      const data = doc.data();
      console.log(`   - ${data.name} (${data.email})`);
    });
    
    // Consulta 3: Usuarios por fecha de creaci√≥n REAL
    console.log('\nüîç Consultando usuarios ordenados por creaci√≥n...');
    const dateQuery = query(usuariosCollection, orderBy('creation', 'desc'), limit(2));
    const dateSnapshot = await getDocs(dateQuery);
    
    console.log(`üìä √öltimos usuarios REALES creados: ${dateSnapshot.size}`);
    dateSnapshot.forEach(doc => {
      const data = doc.data();
      console.log(`   - ${data.name} (creado: ${data.creation})`);
    });
    
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL en consultas con filtros:', error);
    return false;
  }
}

// PRUEBA 5: CONSULTAR FORMULARIOS REALES
async function pruebaConsultarFormulariosUsuarios() {
  logSubsection('PRUEBA 5: CONSULTAR FORMULARIOS REALES DE USUARIOS');
  
  try {
    console.log(`üìç Consultando formularios REALES desde: ${FORMULARIOS_USUARIOS_COLLECTION}`);
    
    const formulariosCollection = collection(db, FORMULARIOS_USUARIOS_COLLECTION);
    const snapshot = await getDocs(formulariosCollection);
    
    console.log(`üìä Total de formularios REALES encontrados: ${snapshot.size}`);
    
    if (!snapshot.empty) {
      console.log('\nüìã Lista de formularios REALES:');
      snapshot.forEach((docSnap, index) => {
        const data = docSnap.data();
        console.log(`${index + 1}. ${data.nombre} - ${data.tipoUsuario}`);
        console.log(`   üìÖ Fecha: ${data.fechaCreacion}`);
        console.log(`   üÜî Chat ID: ${data.chatId}`);
        console.log(`   üìß Email: ${data.email}`);
        console.log(`   üìç Source: ${data.source}`);
      });
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL consultando formularios:', error);
    return false;
  }
}

// PRUEBA 6: VERIFICAR OBTENER POR ID REAL
async function pruebaObtenerPorId() {
  logSubsection('PRUEBA 6: OBTENER USUARIO POR ID REAL');
  
  try {
    const usuarioId = usuariosPrueba[1].id; // Carlos L√≥pez Test
    console.log(`üìç Obteniendo usuario REAL por ID: ${usuarioId}`);
    
    const usuarioRef = doc(db, USUARIOS_COLLECTION, usuarioId);
    const docSnap = await getDoc(usuarioRef);
    
    if (docSnap.exists()) {
      const data = docSnap.data();
      console.log('‚úÖ Usuario REAL encontrado:');
      console.log(`   üë§ Nombre: ${data.name}`);
      console.log(`   üìß Email: ${data.email}`);
      console.log(`   üè¢ Empresa: ${data.isEnterprise ? 'S√≠' : 'No'}`);
      console.log(`   üè∑Ô∏è Labels: ${data.labels}`);
      console.log(`   üí∞ Fee: $${data.userInteractions?.fee}`);
      console.log(`   üì± WhatsApp: ${data.whatsAppName}`);
      console.log(`   üìÖ Creado: ${data.creation}`);
      
      return true;
    } else {
      console.log('‚ùå Usuario no encontrado REALMENTE');
      return false;
    }
  } catch (error) {
    console.error('‚ùå Error REAL obteniendo usuario por ID:', error);
    return false;
  }
}

// PRUEBA 7: RENDIMIENTO REAL
async function pruebaRendimientoReal() {
  logSubsection('PRUEBA 7: RENDIMIENTO REAL DE CONSULTAS');
  
  try {
    const startTime = Date.now();
    
    // Consultas m√∫ltiples REALES en paralelo
    const usuariosCollection = collection(db, USUARIOS_COLLECTION);
    const formulariosCollection = collection(db, FORMULARIOS_USUARIOS_COLLECTION);
    
    const promises = [
      getDocs(usuariosCollection),
      getDocs(formulariosCollection),
      getDocs(query(usuariosCollection, where('isWAContact', '==', true))),
      getDocs(query(usuariosCollection, orderBy('creation', 'desc'), limit(2)))
    ];
    
    const results = await Promise.all(promises);
    
    const endTime = Date.now();
    const totalTime = endTime - startTime;
    
    console.log('üìä Resultados de rendimiento REAL:');
    console.log(`   ‚è±Ô∏è Tiempo total: ${totalTime}ms`);
    console.log(`   üë• Usuarios principales: ${results[0].size}`);
    console.log(`   üìù Formularios: ${results[1].size}`);
    console.log(`   üì± Con WhatsApp: ${results[2].size}`);
    console.log(`   üîù √öltimos 2: ${results[3].size}`);
    console.log(`   üöÄ Promedio por consulta: ${(totalTime/4).toFixed(2)}ms`);
    
    return true;
  } catch (error) {
    console.error('‚ùå Error REAL en prueba de rendimiento:', error);
    return false;
  }
}

// GENERAR REPORTE FINAL REAL
async function generarReporteReal(resultados) {
  logSeparator();
  console.log('üìä REPORTE FINAL DE PRUEBAS REALES EN FIRESTORE');
  logSeparator();
  
  const totalPruebas = resultados.length;
  const pruebasExitosas = resultados.filter(r => r.resultado).length;
  const pruebasFallidas = totalPruebas - pruebasExitosas;
  
  console.log(`\nüìà RESUMEN GENERAL DE PRUEBAS REALES:`);
  console.log(`   ‚úÖ Pruebas exitosas: ${pruebasExitosas}/${totalPruebas}`);
  console.log(`   ‚ùå Pruebas fallidas: ${pruebasFallidas}/${totalPruebas}`);
  console.log(`   üìä Porcentaje de √©xito: ${((pruebasExitosas/totalPruebas) * 100).toFixed(1)}%`);
  
  console.log('\nüìã DETALLE POR PRUEBA REAL:');
  resultados.forEach((resultado, index) => {
    const status = resultado.resultado ? '‚úÖ' : '‚ùå';
    console.log(`   ${status} ${index + 1}. ${resultado.nombre}`);
  });
  
  console.log('\nüî• DATOS REALES EN FIRESTORE:');
  console.log(`   üìç Usuarios principales: ${USUARIOS_COLLECTION}`);
  console.log(`   üìù Formularios usuarios: ${FORMULARIOS_USUARIOS_COLLECTION}`);
  console.log(`   üè™ Restaurante prueba: ${RESTAURANTE_PRUEBA}`);
  console.log(`   üîó Proyecto Firebase: bocket-2024`);
  
  console.log('\n‚úÖ CAMBIOS VERIFICADOS REALMENTE:');
  console.log('   üóÇÔ∏è Tabla "clientes" ‚Üí "usuarios" funcionando');
  console.log('   üîÑ CRUD completo funcional en Firestore REAL');
  console.log('   üìä Consultas con filtros funcionando');
  console.log('   üöÄ Rendimiento verificado');
  console.log('   üìã Formularios organizados cre√°ndose');
  
  if (pruebasExitosas === totalPruebas) {
    console.log('\nüéâ ¬°TODAS LAS PRUEBAS REALES PASARON!');
    console.log('‚úÖ La tabla "usuarios" est√° funcionando PERFECTAMENTE en Firestore');
    console.log('üî• Los cambios est√°n COMPLETAMENTE implementados y verificados');
  } else {
    console.log('\n‚ö†Ô∏è ALGUNAS PRUEBAS REALES FALLARON');
    console.log('üîç Revisa los detalles arriba para identificar problemas REALES');
  }
  
  console.log('\n‚ö†Ô∏è IMPORTANTE - DATOS DE PRUEBA:');
  console.log(`   üóÇÔ∏è Se crearon datos de prueba en: ${RESTAURANTE_PRUEBA}`);
  console.log('   üßπ Estos datos pueden eliminarse manualmente si es necesario');
  console.log('   üìä Los datos NO afectan la funcionalidad de producci√≥n');
}

// FUNCI√ìN PRINCIPAL
async function ejecutarPruebasReales() {
  console.log('üî• INICIANDO PRUEBAS REALES DE LA TABLA USUARIOS EN FIRESTORE');
  console.log(`üìÖ Fecha: ${new Date().toISOString()}`);
  console.log(`üè™ Restaurante de prueba: ${RESTAURANTE_PRUEBA}`);
  console.log(`üîó Proyecto Firebase: bocket-2024`);
  logSeparator();
  
  const resultados = [];
  
  // Ejecutar todas las pruebas REALES
  const pruebasReales = [
    { nombre: 'Crear usuarios REALES', funcion: pruebaCrearUsuarios },
    { nombre: 'Consultar usuarios REALES', funcion: pruebaConsultarUsuarios },
    { nombre: 'Actualizar usuario REAL', funcion: pruebaActualizarUsuario },
    { nombre: 'Consultar por filtros REALES', funcion: pruebaConsultarPorFiltros },
    { nombre: 'Consultar formularios REALES', funcion: pruebaConsultarFormulariosUsuarios },
    { nombre: 'Obtener por ID REAL', funcion: pruebaObtenerPorId },
    { nombre: 'Rendimiento REAL', funcion: pruebaRendimientoReal }
  ];
  
  for (const prueba of pruebasReales) {
    try {
      console.log(`\nüöÄ Ejecutando REAL: ${prueba.nombre}`);
      const resultado = await prueba.funcion();
      resultados.push({ nombre: prueba.nombre, resultado });
      
      if (resultado) {
        console.log(`‚úÖ ${prueba.nombre} - EXITOSA (REAL)`);
      } else {
        console.log(`‚ùå ${prueba.nombre} - FALLIDA (REAL)`);
      }
      
      await delay(1000); // Pausa entre pruebas para Firestore
    } catch (error) {
      console.error(`‚ùå Error REAL en ${prueba.nombre}:`, error);
      resultados.push({ nombre: prueba.nombre, resultado: false });
    }
  }
  
  // Generar reporte final REAL
  await generarReporteReal(resultados);
  
  return resultados.filter(r => r.resultado).length === resultados.length;
}

// Ejecutar el script
if (require.main === module) {
  ejecutarPruebasReales()
    .then((exito) => {
      console.log(`\nüèÅ Pruebas REALES completadas - ${exito ? 'TODAS EXITOSAS' : 'REVISAR FALLOS'}`);
      process.exit(exito ? 0 : 1);
    })
    .catch((error) => {
      console.error('\nüí• Error fatal en pruebas REALES:', error);
      process.exit(1);
    });
}

module.exports = {
  ejecutarPruebasReales,
  RESTAURANTE_PRUEBA,
  USUARIOS_COLLECTION,
  FORMULARIOS_USUARIOS_COLLECTION
};
<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/clientes"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ esEdicion ? 'Editar Cliente' : 'Nuevo Cliente' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancelar()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-progress-bar *ngIf="guardando || cargando" type="indeterminate" color="secondary"></ion-progress-bar>
</ion-header>

<ion-content class="form-content">
  <form [formGroup]="formularioCliente" (ngSubmit)="guardarCliente()" class="modern-form">
    
    <!-- Card de Información Principal -->
    <ion-card class="form-card animated fadeInUp">
      <ion-card-header class="card-header-gradient">
        <ion-card-title>
          <ion-icon name="person-circle" class="section-icon"></ion-icon>
          Información Personal
        </ion-card-title>
        <ion-card-subtitle>Datos básicos del cliente</ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <!-- Número WhatsApp con validación visual -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input" [class.invalid]="esCampoInvalido('id')">
                  <ion-icon name="logo-whatsapp" slot="start" color="success"></ion-icon>
                  <ion-label position="stacked">WhatsApp *</ion-label>
                  <ion-input 
                    formControlName="id" 
                    type="tel"
                    placeholder="+57 300 123 4567"
                    (ionChange)="onIdChange()"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="esCampoInvalido('id')">
                  <ion-icon name="alert-circle"></ion-icon>
                  {{ obtenerMensajeError('id') || 'Ingrese un número válido (10-15 dígitos)' }}
                </div>
                <div class="hint-message" *ngIf="!esCampoInvalido('id') && formularioCliente.get('id')?.value">
                  <ion-icon name="checkmark-circle" color="success"></ion-icon>
                  Número válido
                </div>
              </div>
            </ion-col>

            <!-- Nombre completo -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input" [class.invalid]="esCampoInvalido('name')">
                  <ion-icon name="person" slot="start" color="primary"></ion-icon>
                  <ion-label position="stacked">Nombre Completo *</ion-label>
                  <ion-input 
                    formControlName="name" 
                    type="text"
                    placeholder="Juan Pérez"
                    (ionChange)="actualizarNombresDinamicos()"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="esCampoInvalido('name')">
                  <ion-icon name="alert-circle"></ion-icon>
                  {{ obtenerMensajeError('name') }}
                </div>
              </div>
            </ion-col>

            <!-- Email con validación instantánea -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input" [class.invalid]="esCampoInvalido('email')">
                  <ion-icon name="mail" slot="start" color="tertiary"></ion-icon>
                  <ion-label position="stacked">Email</ion-label>
                  <ion-input 
                    formControlName="email" 
                    type="email"
                    placeholder="correo@ejemplo.com"
                    (ionBlur)="validarEmail()"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="esCampoInvalido('email')">
                  <ion-icon name="alert-circle"></ion-icon>
                  {{ obtenerMensajeError('email') }}
                </div>
              </div>
            </ion-col>

            <!-- Empresa -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input">
                  <ion-icon name="business" slot="start" color="secondary"></ion-icon>
                  <ion-label position="stacked">Empresa</ion-label>
                  <ion-input 
                    formControlName="company" 
                    type="text"
                    placeholder="Nombre de la empresa"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
              </div>
            </ion-col>

            <!-- Dirección -->
            <ion-col size="12">
              <div class="form-field">
                <ion-item lines="none" class="modern-input">
                  <ion-icon name="location" slot="start" color="warning"></ion-icon>
                  <ion-label position="stacked">Dirección</ion-label>
                  <ion-textarea 
                    formControlName="address"
                    placeholder="Calle 123 #45-67, Barrio, Ciudad"
                    [autoGrow]="true"
                    rows="2">
                  </ion-textarea>
                </ion-item>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Card de Configuración -->
    <ion-card class="form-card animated fadeInUp delay-1">
      <ion-card-header class="card-header-gradient secondary">
        <ion-card-title>
          <ion-icon name="settings" class="section-icon"></ion-icon>
          Configuración del Cliente
        </ion-card-title>
        <ion-card-subtitle>Tipo de cliente y preferencias</ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <!-- Presets rápidos -->
        <div class="preset-buttons">
          <ion-chip (click)="aplicarPresetVIP()" color="warning" outline>
            <ion-icon name="star"></ion-icon>
            <ion-label>Cliente VIP</ion-label>
          </ion-chip>
          <ion-chip (click)="aplicarPresetCorporativo()" color="tertiary" outline>
            <ion-icon name="briefcase"></ion-icon>
            <ion-label>Corporativo</ion-label>
          </ion-chip>
        </div>

        <ion-grid>
          <ion-row>
            <!-- Tipo de Fuente -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input">
                  <ion-icon name="git-branch" slot="start"></ion-icon>
                  <ion-label position="stacked">Fuente de Registro *</ion-label>
                  <ion-select formControlName="sourceType" (ionChange)="onSourceTypeChange()" interface="popover">
                    <ion-select-option *ngFor="let tipo of tiposSource" [value]="tipo.value">
                      {{ tipo.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </ion-col>

            <!-- Tipo de Respuesta -->
            <ion-col size="12" size-md="6">
              <div class="form-field">
                <ion-item lines="none" class="modern-input">
                  <ion-icon name="chatbubbles" slot="start"></ion-icon>
                  <ion-label position="stacked">Tipo de Respuesta *</ion-label>
                  <ion-select formControlName="respType" interface="popover">
                    <ion-select-option *ngFor="let tipo of tiposRespuesta" [value]="tipo.value">
                      {{ tipo.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </ion-col>

            <!-- Etiquetas -->
            <ion-col size="12">
              <div class="form-field">
                <ion-item lines="none" class="modern-input">
                  <ion-icon name="pricetags" slot="start" color="secondary"></ion-icon>
                  <ion-label position="stacked">Etiquetas</ion-label>
                  <ion-input 
                    formControlName="labels" 
                    type="text"
                    placeholder="cliente_vip, frecuente, eventos"
                    [clearInput]="true">
                  </ion-input>
                </ion-item>
                <div class="hint-message">
                  <ion-icon name="information-circle"></ion-icon>
                  Separe las etiquetas con comas
                </div>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Toggle switches con diseño mejorado -->
        <div class="toggle-section">
          <ion-list lines="none">
            <ion-item class="toggle-item">
              <ion-icon name="briefcase" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Cliente Empresarial</h3>
                <p>Marca si es una empresa o corporación</p>
              </ion-label>
              <ion-toggle formControlName="isEnterprise" color="primary"></ion-toggle>
            </ion-item>

            <ion-item class="toggle-item">
              <ion-icon name="storefront" slot="start" color="secondary"></ion-icon>
              <ion-label>
                <h3>Cliente Business</h3>
                <p>Tiene cuenta WhatsApp Business</p>
              </ion-label>
              <ion-toggle formControlName="isBusiness" color="secondary"></ion-toggle>
            </ion-item>

            <ion-item class="toggle-item">
              <ion-icon name="shield-checkmark" slot="start" color="success"></ion-icon>
              <ion-label>
                <h3>Contacto Verificado</h3>
                <p>Cliente verificado en WhatsApp</p>
              </ion-label>
              <ion-toggle formControlName="isWAContact" color="success"></ion-toggle>
            </ion-item>
          </ion-list>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Card de Estadísticas (solo en edición) -->
    <ion-card class="form-card animated fadeInUp delay-2" *ngIf="esEdicion">
      <ion-card-header class="card-header-gradient tertiary">
        <ion-card-title>
          <ion-icon name="analytics" class="section-icon"></ion-icon>
          Estadísticas de Interacción
        </ion-card-title>
        <ion-card-subtitle>Total de interacciones: {{ calcularTotalInteracciones() }}</ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <div class="stats-grid" formGroupName="userInteractions">
          <div class="stat-item" *ngFor="let stat of [
            {key: 'whatsapp', icon: 'logo-whatsapp', label: 'WhatsApp', color: 'success'},
            {key: 'chatbot', icon: 'chatbubble-ellipses', label: 'Chatbot', color: 'primary'},
            {key: 'api', icon: 'code-slash', label: 'API', color: 'tertiary'},
            {key: 'client', icon: 'person', label: 'Cliente', color: 'secondary'}
          ]">
            <ion-icon [name]="stat.icon" [color]="stat.color"></ion-icon>
            <span class="stat-label">{{ stat.label }}</span>
            <span class="stat-value">{{ formularioCliente.get('userInteractions.' + stat.key)?.value || 0 }}</span>
          </div>
        </div>

        <!-- Botón para ver más estadísticas -->
        <ion-button 
          expand="block" 
          fill="clear" 
          size="small" 
          (click)="toggleCamposTecnicos()"
          class="stats-toggle">
          <ion-icon [name]="mostrarCamposTecnicos ? 'chevron-up' : 'chevron-down'" slot="end"></ion-icon>
          {{ mostrarCamposTecnicos ? 'Ocultar' : 'Ver más' }} estadísticas
        </ion-button>

        <!-- Estadísticas adicionales -->
        <div class="additional-stats" *ngIf="mostrarCamposTecnicos" @slideDown>
          <ion-grid>
            <ion-row>
              <ion-col size="6" *ngFor="let stat of [
                {key: 'controller', label: 'Controller'},
                {key: 'campaing', label: 'Campañas'},
                {key: 'others', label: 'Otros'},
                {key: 'wappController', label: 'WA Controller'},
                {key: 'ai', label: 'IA'},
                {key: 'fee', label: 'Tarifas'}
              ]">
                <ion-item lines="none" class="stat-input">
                  <ion-label position="stacked">{{ stat.label }}</ion-label>
                  <ion-input 
                    type="number" 
                    [formControlName]="stat.key"
                    min="0">
                  </ion-input>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Mensaje de error global -->
    <ion-card *ngIf="error" class="error-card animated shake">
      <ion-card-content>
        <ion-icon name="alert-circle" color="danger"></ion-icon>
        <p>{{ error }}</p>
      </ion-card-content>
    </ion-card>

  </form>
</ion-content>

<!-- Footer con botones de acción -->
<ion-footer class="form-footer">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="cancelar()" fill="clear" color="medium">
        <ion-icon name="close" slot="start"></ion-icon>
        Cancelar
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button 
        (click)="guardarCliente()" 
        [disabled]="formularioCliente.invalid || guardando"
        fill="solid"
        color="primary"
        class="save-button">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        {{ esEdicion ? 'Actualizar' : 'Guardar' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>